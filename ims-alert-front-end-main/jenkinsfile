pipeline {
    agent any

    environment {
        FRONTEND_DIR = 'ims-alert-front-end-main'           // Relative path inside the repo
        BUILD_DIR = 'dist/velzon'                           // Angular output folder
        DEPLOY_DIR = '/var/lib/jenkins/workspace/IMS-Frontend/ims-alert'  // Final deployment target
        NODE_ENV = 'production'
    }

    stages {
        stage('Clone Repository') {
            steps {
                git branch: 'release', url: 'git@github.com:MrNerdyPants/IMS.git'
            }
        }

        stage('Verify Node.js & Angular CLI') {
            steps {
                dir("${FRONTEND_DIR}") {
                    sh 'node -v'
                    sh 'npm -v'
                    sh 'npx ng version'
                }
            }
        }

        stage('Install Dependencies') {
            steps {
                dir("${FRONTEND_DIR}") {
                    // npm ci ensures a clean and repeatable install
                    sh 'npm ci'
                }
            }
        }

        stage('Build Angular App') {
            steps {
                dir("${FRONTEND_DIR}") {
                    // Use npx to avoid global ng dependency
                    sh 'npx ng build --configuration=production'
                }
            }
        }

        stage('Deploy') {
            steps {
                dir("${FRONTEND_DIR}") {
                    script {
                        if (fileExists("${BUILD_DIR}")) {
                            echo "üöÄ Deploying build to ${DEPLOY_DIR}..."

                            // Clear old deploy dir if exists
                            sh "rm -rf ${DEPLOY_DIR} || true"

                            // Recreate and copy contents
                            sh """
                                mkdir -p ${DEPLOY_DIR}
                                cp -r ${BUILD_DIR}/* ${DEPLOY_DIR}/
                            """

                            echo "‚úÖ Frontend deployed to ${DEPLOY_DIR}"
                        } else {
                            error "‚ùå Build directory not found: ${BUILD_DIR}"
                        }
                    }
                }
            }
        }
    }

    post {
        success {
            echo '‚úÖ Frontend Build and Deployment Successful!'
        }
        failure {
            echo '‚ùå Frontend Build Failed!'
        }
    }
}

